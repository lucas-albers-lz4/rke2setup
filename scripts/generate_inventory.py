#!/usr/bin/env python3

import yaml
import argparse
from pathlib import Path
from typing import Dict, List

WARNING_HEADER = """#####################################################################
# WARNING: THIS IS A GENERATED FILE. DO NOT EDIT DIRECTLY!
# 
# This file is automatically generated by scripts/generate_inventory.py
# To make changes, modify the generation script and regenerate this file.
#####################################################################

"""

def parse_hosts_file(hosts_file: str) -> tuple[List[str], List[str]]:
    """Parse hosts.txt file to extract control plane and worker IPs."""
    control_plane_ips = []
    worker_ips = []
    
    with open(hosts_file, 'r') as f:
        lines = f.readlines()
        in_three_node = False
        
        for line in lines:
            line = line.strip()
            if not line or line.startswith('#'):
                continue
                
            if '[three_node]' in line:
                in_three_node = True
                continue
                
            if in_three_node and line:
                # First node is control plane, rest are workers
                parts = line.split()
                if len(parts) >= 2:
                    ip = parts[1]
                    if not control_plane_ips:
                        control_plane_ips.append(ip)
                    else:
                        worker_ips.append(ip)
    
    return control_plane_ips, worker_ips

def generate_inventory(control_plane_ips: List[str], worker_ips: List[str]) -> Dict:
    """Generate inventory structure."""
    inventory = {
        'all': {
            'children': {
                'three_node_cluster': {
                    'children': {
                        'three_node_control_plane': {
                            'hosts': {}
                        },
                        'three_node_worker': {
                            'hosts': {}
                        }
                    }
                }
            },
            'vars': {
                'ansible_python_interpreter': '/usr/bin/python3',
                'ansible_ssh_common_args': '-o StrictHostKeyChecking=no',
                'ansible_user': 'ubuntu'
            }
        }
    }

    # Add control plane node
    for idx, ip in enumerate(control_plane_ips, 1):
        inventory['all']['children']['three_node_cluster']['children']['three_node_control_plane']['hosts'][f'K{idx}'] = {
            'ansible_host': ip
        }

    # Add worker nodes
    for idx, ip in enumerate(worker_ips, len(control_plane_ips) + 1):
        inventory['all']['children']['three_node_cluster']['children']['three_node_worker']['hosts'][f'K{idx}'] = {
            'ansible_host': ip
        }

    return inventory

def main():
    parser = argparse.ArgumentParser(description='Generate RKE2 cluster inventory')
    parser.add_argument('hosts_file', help='Path to hosts.txt file')
    parser.add_argument('--output', default='inventory/rke2.yml', help='Output inventory file path')
    
    args = parser.parse_args()
    
    control_plane_ips, worker_ips = parse_hosts_file(args.hosts_file)
    inventory = generate_inventory(control_plane_ips, worker_ips)
    
    with open(args.output, 'w') as f:
        f.write(WARNING_HEADER)
        yaml.dump(inventory, f, default_flow_style=False, sort_keys=False, indent=2)

if __name__ == '__main__':
    main()