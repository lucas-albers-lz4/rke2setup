#!/usr/bin/env python3

import yaml
import argparse
from pathlib import Path
from typing import Dict, List

WARNING_HEADER = """#####################################################################
# WARNING: THIS IS A GENERATED FILE. DO NOT EDIT DIRECTLY!
# 
# This file is automatically generated by scripts/generate_inventory.py
# To make changes, modify the generation script and regenerate this file.
#####################################################################

"""

def parse_hosts_file(hosts_file: str) -> tuple[List[tuple], List[tuple]]:
    """Parse hosts.txt file to extract control plane and worker node info as (hostname, ip) tuples."""
    control_plane_nodes = []
    worker_nodes = []
    
    with open(hosts_file, 'r') as f:
        lines = f.readlines()
        in_six_node = False
        
        for line in lines:
            line = line.strip()
            if not line or line.startswith('#'):
                continue
                
            if '[six_node]' in line:
                in_six_node = True
                continue
                
            if in_six_node and line:
                # Parse hostname and IP
                parts = line.split()
                if len(parts) >= 2:
                    hostname = parts[0]
                    ip = parts[1]
                    
                    # First 3 nodes are control plane, next 3 are workers
                    if len(control_plane_nodes) < 3:
                        control_plane_nodes.append((hostname, ip))
                    else:
                        worker_nodes.append((hostname, ip))
    
    return control_plane_nodes, worker_nodes

def generate_inventory(control_plane_nodes: List[tuple], worker_nodes: List[tuple]) -> Dict:
    """Generate inventory structure."""
    inventory = {
        'all': {
            'children': {
                'six_node_cluster': {
                    'children': {
                        'control_plane_nodes': {
                            'hosts': {}
                        },
                        'worker_nodes': {
                            'hosts': {}
                        }
                    }
                }
            },
            'vars': {
                'ansible_python_interpreter': '/usr/bin/python3',
                'ansible_ssh_common_args': '-o StrictHostKeyChecking=no',
                'ansible_user': 'ubuntu'
            }
        }
    }

    # Add control plane nodes
    for hostname, ip in control_plane_nodes:
        inventory['all']['children']['six_node_cluster']['children']['control_plane_nodes']['hosts'][hostname] = {
            'ansible_host': ip
        }

    # Add worker nodes
    for hostname, ip in worker_nodes:
        inventory['all']['children']['six_node_cluster']['children']['worker_nodes']['hosts'][hostname] = {
            'ansible_host': ip
        }

    return inventory

def main():
    parser = argparse.ArgumentParser(description='Generate RKE2 cluster inventory')
    parser.add_argument('hosts_file', help='Path to hosts.txt file')
    parser.add_argument('--output', default='inventory/rke2.yml', help='Output inventory file path')
    
    args = parser.parse_args()
    
    control_plane_nodes, worker_nodes = parse_hosts_file(args.hosts_file)
    inventory = generate_inventory(control_plane_nodes, worker_nodes)
    
    with open(args.output, 'w') as f:
        f.write(WARNING_HEADER)
        yaml.dump(inventory, f, default_flow_style=False, sort_keys=False, indent=2)

if __name__ == '__main__':
    main()