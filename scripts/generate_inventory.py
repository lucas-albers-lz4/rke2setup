#!/usr/bin/env python3

import yaml
import os
import ipaddress
import sys

def validate_node_data(nodes):
    """Validate node data format and IP addresses."""
    for hostname, ip in nodes:
        if not hostname or not isinstance(hostname, str):
            raise ValueError(f"Invalid hostname: {hostname}")
        try:
            ipaddress.ip_address(ip)
        except ValueError:
            raise ValueError(f"Invalid IP address: {ip}")
    return True

def generate_inventory_structure(control_plane_nodes, worker_nodes):
    """Generate the inventory structure from node lists."""
    inventory = {
        'all': {
            'children': {
                'six_node_cluster': {
                    'children': {
                        'control_plane_nodes': {'hosts': {}},
                        'worker_nodes': {'hosts': {}}
                    }
                }
            },
            'vars': {
                'ansible_user': 'ubuntu',
                'ansible_python_interpreter': '/usr/bin/python3',
                'ansible_ssh_common_args': '-o StrictHostKeyChecking=no'
            }
        }
    }
    
    for hostname, ip in control_plane_nodes:
        inventory['all']['children']['six_node_cluster']['children']['control_plane_nodes']['hosts'][hostname] = {
            'ansible_host': ip
        }
    
    for hostname, ip in worker_nodes:
        inventory['all']['children']['six_node_cluster']['children']['worker_nodes']['hosts'][hostname] = {
            'ansible_host': ip
        }
    
    return inventory

def parse_hosts_file(hosts_file):
    """Parse hosts.txt file and return control plane and worker nodes."""
    ip_mappings = {}  # Store hostname -> IP mappings
    control_plane_nodes = []
    worker_nodes = []
    current_section = None
    
    with open(hosts_file, 'r') as f:
        for line in f:
            line = line.strip()
            if not line or line.startswith('#'):
                continue
            
            if line == '[six_node]':
                current_section = 'ip_mapping'
            elif line == '[control_plane_nodes]':
                current_section = 'control_plane'
            elif line == '[worker_nodes]':
                current_section = 'worker'
            elif line.startswith('['):
                current_section = None
            elif current_section == 'ip_mapping':
                parts = line.split()
                if len(parts) >= 2:
                    hostname, ip = parts[0], parts[1]
                    ip_mappings[hostname] = ip
            elif current_section in ['control_plane', 'worker']:
                hostname = line.strip()
                if hostname in ip_mappings:
                    node_tuple = (hostname, ip_mappings[hostname])
                    if current_section == 'control_plane':
                        control_plane_nodes.append(node_tuple)
                    else:
                        worker_nodes.append(node_tuple)
    
    return control_plane_nodes, worker_nodes

def write_inventory_file(inventory_data, file_path):
    """Write inventory data to a YAML file."""
    header = """---
#####################################################################
# WARNING: THIS IS A GENERATED FILE. DO NOT EDIT DIRECTLY!
# 
# This file is automatically generated by scripts/generate_inventory.py
# To make changes, modify inventory/hosts.txt and regenerate this file.
#####################################################################
"""
    os.makedirs(os.path.dirname(file_path), exist_ok=True)
    with open(file_path, 'w') as f:
        f.write(header)
        yaml.dump(inventory_data, f, default_flow_style=False, sort_keys=False)

def main():
    if len(sys.argv) != 2:
        print("Usage: generate_inventory.py <hosts_file>")
        sys.exit(1)
    
    hosts_file = sys.argv[1]
    output_file = 'inventory/rke2.yml'
    
    try:
        # Parse hosts.txt
        control_plane_nodes, worker_nodes = parse_hosts_file(hosts_file)
        
        # Validate node data
        validate_node_data(control_plane_nodes + worker_nodes)
        
        # Generate inventory structure
        inventory = generate_inventory_structure(control_plane_nodes, worker_nodes)
        
        # Write to file
        write_inventory_file(inventory, output_file)
        print(f"Generated inventory file: {output_file}")
        
    except Exception as e:
        print(f"Error: {str(e)}", file=sys.stderr)
        sys.exit(1)

if __name__ == '__main__':
    main()