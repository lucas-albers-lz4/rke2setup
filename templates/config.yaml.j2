---
{% if node_type == 'server' %}
token: {{ hostvars[groups['three_node_control_plane' if cluster_type == 'three_node' else 'control_plane_nodes'][0]].token | default('') }}
{% if not is_first_server %}
server: https://{{ first_server_ip }}:9345
{% endif %}
tls-san:
{% for san in tls_sans %}
  - {{ san }}
{% endfor %}
{% endif %}

# Networking
cluster-domain: {{ cluster_domain }}
cluster-cidr: {{ pod_cidr }}
service-cidr: {{ service_cidr }}

# Node configuration
node-name: {{ inventory_hostname }}
{% if node_type == 'agent' %}
server: https://{{ hostvars[groups['three_node_control_plane' if cluster_type == 'three_node' else 'control_plane_nodes'][0]]['ansible_host'] }}:9345
token: {{ hostvars[groups['three_node_control_plane' if cluster_type == 'three_node' else 'control_plane_nodes'][0]].token | default('') }}
{% endif %}

# Node configuration
node-label:
{% if node_labels | length > 0 %}
{% for key, value in node_labels.items() %}
  - "{{ key }}={{ value }}"
{% endfor %}
{% endif %}

{% if node_taints | length > 0 %}
node-taint:
{% for taint in node_taints %}
  - "{{ taint }}"
{% endfor %}
{% endif %}

# System configuration
data-dir: /var/lib/rancher/rke2
write-kubeconfig-mode: "0644"
